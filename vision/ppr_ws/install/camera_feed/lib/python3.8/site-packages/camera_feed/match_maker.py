import os
import shutil

def pair_match_checkerboard_images(base_dir, output_dir):
    """
    Matches images with the exact same name between specified camera pairs
    and groups them into separate subdirectories for each pair, excluding
    files with "none" in their filenames.

    Parameters:
    - base_dir: Directory containing the camera folders.
    - output_dir: Directory where matched files will be saved.
    """
    # Define the camera pairs to match
    camera_pairs = [(0, 3), (1, 3), (2, 3)]
    
    # Create the output directory if it doesn't exist
    os.makedirs(output_dir, exist_ok=True)

    for cam_a, cam_b in camera_pairs:
        cam_a_dir = os.path.join(base_dir, f"camera_{cam_a}_processed")
        cam_b_dir = os.path.join(base_dir, f"camera_{cam_b}_processed")

        # Check if both directories exist
        if not os.path.isdir(cam_a_dir):
            raise FileNotFoundError(f"Camera directory not found: {cam_a_dir}")
        if not os.path.isdir(cam_b_dir):
            raise FileNotFoundError(f"Camera directory not found: {cam_b_dir}")

        # Get all filenames in each directory, excluding files with "none" in their names
        filenames_a = {f for f in os.listdir(cam_a_dir) 
                       if os.path.isfile(os.path.join(cam_a_dir, f)) and "none" not in f.lower()}
        filenames_b = {f for f in os.listdir(cam_b_dir) 
                       if os.path.isfile(os.path.join(cam_b_dir, f)) and "none" not in f.lower()}

        # Find common filenames between the two cameras
        common_filenames = filenames_a.intersection(filenames_b)
        print(f"Found {len(common_filenames)} common files between camera_{cam_a} and camera_{cam_b} (excluding 'none').")

        # Create a subdirectory for this pair
        pair_output_dir = os.path.join(output_dir, f"cam_{cam_a}_cam_{cam_b}")
        os.makedirs(pair_output_dir, exist_ok=True)

        # Copy matched files to the output directory
        for filename in common_filenames:
            # Copy from Camera A
            src_a = os.path.join(cam_a_dir, filename)
            dst_a = os.path.join(pair_output_dir, f"cam_{cam_a}_{filename}")
            shutil.copy(src_a, dst_a)

            # Copy from Camera B
            src_b = os.path.join(cam_b_dir, filename)
            dst_b = os.path.join(pair_output_dir, f"cam_{cam_b}_{filename}")
            shutil.copy(src_b, dst_b)

    print(f"Matching complete. Matched files saved to: {output_dir}")


# Example usage
base_directory = "./calibration_images"  # Replace with your base directory
output_directory = "./matched_checkerboards"  # Replace with your output directory

pair_match_checkerboard_images(base_directory, output_directory)
