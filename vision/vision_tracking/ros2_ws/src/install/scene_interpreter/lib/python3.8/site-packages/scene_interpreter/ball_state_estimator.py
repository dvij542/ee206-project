import cv2
from .triangulation_utils import triangulate
from .NaiveBallDetector import NaiveBallDetector

# Provide the detector wrapper object type to specify the detection algorithm. 
# Types can be found in the ball_detector.py class with speicifications of their 
# corresponding detection algorithms.
def estimate_ball_3D_spatial_coords(detector_obj_type):
    # we maintain a state of our system to reject outliers
    cam1_detector = detector_obj_type(1)
    cam2_detector = detector_obj_type(2)
    cam3_detector = detector_obj_type(3)
    cam4_detector = detector_obj_type(4)

    def helper(frame_cam1, frame_cam2, frame_cam3, frame_cam4):
        """
        Returns an estimate of the ball's spatial position and its associated reprojection error
        """
        center1, radius1 = cam1_detector.next_position(frame_cam1)
        center2, radius2 = cam2_detector.next_position(frame_cam2)
        center3, radius3 = cam3_detector.next_position(frame_cam3)
        center4, radius4 = cam4_detector.next_position(frame_cam4)
        centers = [center1, center2, center3, center4]

        if True:
            if center1 and radius1:
                cv2.circle(frame_cam1, center1, int(radius1), (0, 0, 255), 2)
            if center2 and radius2:
                cv2.circle(frame_cam2, center2, int(radius2), (0, 0, 255), 2)
            if center3 and radius3:
                cv2.circle(frame_cam3, center3, int(radius3), (0, 0, 255), 2)
            if center4 and radius4:
                cv2.circle(frame_cam4, center4, int(radius4), (0, 0, 255), 2)

            cv2.imshow("Frame1", frame_cam1)
            cv2.imshow("Frame2", frame_cam2)
            cv2.imshow("Frame3", frame_cam3)
            cv2.imshow("Frame4", frame_cam4)
            cv2.waitKey(1)

        ball_spatial_coords, error = triangulate(centers)
        print("Triangulation estimate: ", ball_spatial_coords, error)

        return ball_spatial_coords, error

    return helper

estimate_ball_3D_spatial_coords = estimate_ball_3D_spatial_coords(detector_obj_type = NaiveBallDetector)